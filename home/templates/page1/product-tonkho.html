{% extends "page1/base.html" %}

{% block title %}Product{% endblock %}

{% block content %}

    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style-product-tonkho.css' %}">
    <div class="header-row" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <h2 style="margin-top: 25px; margin-left: 20px">Danh S√°ch S·∫£n Ph·∫©m T·ªìn Kho</h2>
        
        <!-- Form t√¨m ki·∫øm -->
        <form method="get" class="search-form" style="display: flex; margin-right:20px; margin-top:25px; align-items: center; gap: 8px;">
            <input type="text" name="q" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." value="{{ query|default:'' }}">
            <select name="search_by">
                <option value="name" {% if request.GET.search_by == 'name' %}selected{% endif %}>T√™n s·∫£n ph·∫©m</option>
                <option value="date_added" {% if request.GET.search_by == 'date_added' %}selected{% endif %}>Ng√†y th√™m</option>
                <option value="supplier" {% if request.GET.search_by == 'supplier' %}selected{% endif %}>Nh√† cung c·∫•p</option>
            </select>
            {% if category %}
                <input type="hidden" name="category" value="{{ category }}">
            {% endif %}
            <button type="submit" title="T√¨m ki·∫øm">T√¨m üîç</button>
        </form>    
    </div>

    <!-- B·ªô l·ªçc s·∫£n ph·∫©m, n√∫t S·∫£n ph·∫©m c√≤n √≠t v√† n√∫t Th√™m s·∫£n ph·∫©m -->
    <div class="header-container">
        <div class="dropdown">
            <button class="dropdown-toggle" onclick="toggleDropdown()">Ph√¢n lo·∫°i</button>
            <div class="dropdown-menu" id="dropdownMenu">
                <a href="?category=all" class="{% if category == 'all' %}active{% endif %}">T·∫•t C·∫£</a>
                <a href="?category=ao" class="{% if category == 'ao' %}active{% endif %}">√Åo</a>
                <a href="?category=quan" class="{% if category == 'quan' %}active{% endif %}">Qu·∫ßn</a>
                <a href="?category=vay" class="{% if category == 'vay' %}active{% endif %}">V√°y</a>
                <a href="?category=tat" class="{% if category == 'tat' %}active{% endif %}">T·∫•t</a>
                <a href="?category=giay" class="{% if category == 'giay' %}active{% endif %}">Gi√†y</a>
                <a href="?category=dep" class="{% if category == 'dep' %}active{% endif %}">D√©p</a>
                <a href="?category=mu" class="{% if category == 'mu' %}active{% endif %}">M≈©</a>
                <a href="?category=thatlung" class="{% if category == 'thatlung' %}active{% endif %}">Th·∫Øt L∆∞ng</a>
                <a href="?category=khac" class="{% if category == 'khac' %}active{% endif %}">Kh√°c</a>
            </div>
        </div>
        
        <!-- N√∫t S·∫£n ph·∫©m c√≤n √≠t -->
        <a href="?filter=lowstock" class="less-btn {% if request.GET.filter == 'lowstock' %}active{% endif %}" style="margin-left: 20px;">S·∫£n ph·∫©m c√≤n √≠t</a>

        <!-- N√∫t Th√™m s·∫£n ph·∫©m -->
        <button id="show-form-btn" class="add-product-btn" onclick="toggleForm()">Nh·∫≠p kho</button>
    </div>

    <!-- L·ªõp ph·ªß n·ªÅn t·ªëi -->
    <div id="overlay" class="overlay" onclick="toggleForm()"></div>

    <!-- Form th√™m s·∫£n ph·∫©m (·∫®n m·∫∑c ƒë·ªãnh) -->
    <div class="add-product-form" id="product-form">
        <form method="POST" action="{% url 'add_product' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div style="text-align: center;">
                <h2>Nh·∫≠p s·∫£n ph·∫©m m·ªõi</h2>
            </div>              
            {{ form.as_p }}
            <button type="submit" class="confirm-btn">X√°c nh·∫≠n</button>
            <button type="button" class="cancel-btn" onclick="toggleForm()">H·ªßy</button>
        </form>
    </div>


    <!-- L·ªõp ph·ªß n·ªÅn t·ªëi ch·ªâ d√†nh cho Form S·ª≠a -->
    <div id="edit-overlay" class="overlay" onclick="closeEditForm()"></div>

    <!-- Form s·ª≠a s·∫£n ph·∫©m (·∫®n m·∫∑c ƒë·ªãnh) -->
    <div class="edit-product-form" id="edit-product-form">
        <h2>S·ª≠a s·∫£n ph·∫©m</h2>
        <form id="edit-form" method="POST" action="" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="edit-form-grid">
                <div class="row">
                    <div class="form-group">
                        <label for="edit-product-name">T√™n s·∫£n ph·∫©m:</label>
                        <input type="text" id="edit-product-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-category">Danh m·ª•c:</label>
                        <select id="edit-category" name="category">
                            {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            
                <div class="row">
                    <div class="form-group">
                        <label for="edit-quantity">S·ªë l∆∞·ª£ng:</label>
                        <input type="number" id="edit-quantity" name="quantity" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-purchase-price">Gi√° nh·∫≠p:</label>
                        <input type="number" step="0.01" id="edit-purchase-price" name="purchase_price" required>
                    </div>
                </div>
            
                <div class="row">
                    <div class="form-group">
                        <label for="edit-sale-price">Gi√° b√°n:</label>
                        <input type="number" step="0.01" id="edit-sale-price" name="sale_price" required>
                    </div>    
                    <div class="form-group">
                        <label for="edit-description">M√¥ t·∫£:</label>
                        <textarea id="edit-description" name="description" rows="3"></textarea>
                    </div>
                </div>
            
                <div class="row">
                    <div class="form-group">
                        <label for="edit-image">·∫¢nh s·∫£n ph·∫©m:</label>
                        <input type="file" id="edit-image" name="image" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label for="edit-supplier-name">T√™n nh√† cung c·∫•p:</label>
                        <input type="text" id="edit-supplier-name" name="supplier" required>
                    </div>
                </div>
            
                <!-- Hi·ªÉn th·ªã ·∫£nh hi·ªán t·∫°i -->
                <div class="row">
                    <div class="form-group" style="width: 100%;">
                        <label>·∫¢nh hi·ªán t·∫°i:</label>
                        <img id="current-product-image" src="" alt="·∫¢nh s·∫£n ph·∫©m" style="max-width: 100px; display: none;">
                    </div>
                </div>
            </div>
            
            <!-- Nh√≥m n√∫t -->
            <div class="button-group">
                <button type="submit" class="confirm-btn">L∆∞u</button>
                <button type="button" class="cancel-btn" onclick="closeEditForm()">H·ªßy</button>
            </div>
        </form>
    </div>
    




    <!-- Hi·ªÉn th·ªã s·∫£n ph·∫©m -->
    <div class="product-list">
        {% for product in products %}
        <div class="product-grid-row">
            <!-- ·∫¢nh -->
            <div class="product-grid-img">
                <a href="{% url 'product_detail' product.id %}">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
                    {% else %}
                        <div class="product-image no-image">
                            Kh√¥ng c√≥ ·∫£nh
                        </div>
                    {% endif %}
                </a>
            </div>

            <!-- T√™n s·∫£n ph·∫©m -->
            <div class="product-grid-name">
                <a href="{% url 'product_detail' product.id %}" class="product-name-link">{{ product.name }}</a>
            </div>

            <!-- S·ªë l∆∞·ª£ng -->
            <div class="product-grid-quantity">
                S·ªë l∆∞·ª£ng: {{ product.quantity }}
            </div>

            <!-- Ng√†y th√™m -->
            <div class="product-grid-date">
                Ng√†y th√™m: {{ product.date_added|date:"d/m/Y" }}
            </div>

            <!-- NCC -->
            <div class="product-grid-supplier">
                NCC: {{ product.supplier }}
            </div>

            <!-- S·ª≠a / X√≥a -->
            <div class="product-actions">
                <a href="#" onclick="toggleEditForm('{{ product.id }}', '{{ product.name|escapejs }}', '{{ product.category }}', '{{ product.quantity }}', '{% if product.image and product.image.url %}{{ product.image.url }}{% else %}{% static 'images/no-image.jpg' %}{% endif %}', '{{ product.purchase_price }}', '{{ product.sale_price }}', '{{ product.description|escapejs }}', '{{ product.supplier|escapejs }}')">S·ª≠a</a>
                |
                <a href="{% url 'delete_product' product.id %}" onclick="return confirm('X√≥a s·∫£n ph·∫©m n√†y?');">X√≥a</a>
            </div>
        </div>
        {% empty %}
            <p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong danh m·ª•c n√†y.</p>
        {% endfor %}
    </div>

    <!-- S·∫Øp x·∫øp -->
    <div class="sort-options">
        <label for="sort">S·∫Øp x·∫øp theo:</label>
        <select id="sort" name="order_by" onchange="window.location.href=this.value;">
            <option value="?category={{ category }}&order_by=-name{% if request.GET.order_by == '-name' %}&page={{ request.GET.page }}{% endif %}" {% if order_by == '-name' %}selected{% endif %}>T√™n (A-Z)</option>
            <option value="?category={{ category }}&order_by=name{% if request.GET.order_by == 'name' %}&page={{ request.GET.page }}{% endif %}" {% if order_by == 'name' %}selected{% endif %}>T√™n (Z-A)</option>
            <option value="?category={{ category }}&order_by=-date_added{% if request.GET.order_by == '-date_added' %}&page={{ request.GET.page }}{% endif %}" {% if order_by == '-date_added' %}selected{% endif %}>Ng√†y th√™m (M·ªõi-C≈©)</option>
            <option value="?category={{ category }}&order_by=date_added{% if request.GET.order_by == 'date_added' %}&page={{ request.GET.page }}{% endif %}" {% if order_by == 'date_added' %}selected{% endif %}>Ng√†y th√™m (C≈©-M·ªõi)</option>
        </select>
    </div>
    
    
    <!-- Ph√¢n trang -->
    <div class="pagination">
        {% if products.has_previous %}
            <a href="?category={{ category }}&order_by={{ order_by }}&page=1">Trang ƒë·∫ßu</a>
            <a href="?category={{ category }}&order_by={{ order_by }}&page={{ products.previous_page_number }}">¬´ Tr∆∞·ªõc</a>
        {% endif %}
    
        <span>Trang {{ products.number }} / {{ products.paginator.num_pages }}</span>
    
        {% if products.has_next %}
            <a href="?category={{ category }}&order_by={{ order_by }}&page={{ products.next_page_number }}">Ti·∫øp ¬ª</a>
            <a href="?category={{ category }}&order_by={{ order_by }}&page={{ products.paginator.num_pages }}">Trang cu·ªëi</a>
        {% endif %}
    </div>
    

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const filterButtons = document.querySelectorAll(".filter-btn");
            const products = document.querySelectorAll(".product");

            filterButtons.forEach(button => {
                button.addEventListener("click", function () {
                    // B·ªè active kh·ªèi t·∫•t c·∫£ n√∫t
                    filterButtons.forEach(btn => btn.classList.remove("active"));
                    this.classList.add("active");
                    
                    const category = this.getAttribute("data-category");
                    
                    products.forEach(product => {
                        if (category === "all" || product.getAttribute("data-category") === category) {
                            product.style.display = "block";
                        } else {
                            product.style.display = "none";
                        }
                    });
                });
            });
        });
    </script>
    
    

    <script src="{% static 'js/product-tonkho.js' %}"></script>

{% endblock %}
